<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}{{ club.name if club else 'FleetNests' }}{% endblock %}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&display=swap">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <meta name="theme-color" content="{{ branding.primary_color or '#0A2342' }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/icon-192.png') }}">
  {# Per-club color theme injection #}
  <style>
    :root {
      --club-primary:       {{ branding.primary_color or '#0A2342' }};
      --club-primary-dark:  color-mix(in srgb, {{ branding.primary_color or '#0A2342' }} 70%, #000);
      --club-primary-mid:   color-mix(in srgb, {{ branding.primary_color or '#0A2342' }} 85%, #fff);
      --club-primary-light: color-mix(in srgb, {{ branding.primary_color or '#0A2342' }} 75%, #fff);
      --club-accent:        {{ branding.accent_color or '#C9A84C' }};
      --club-accent-dark:   color-mix(in srgb, {{ branding.accent_color or '#C9A84C' }} 80%, #000);
      --club-accent-light:  color-mix(in srgb, {{ branding.accent_color or '#C9A84C' }} 70%, #fff);
    }
  </style>
  {% block head %}{% endblock %}
</head>
<body>

{# ── Demo-site notice bar (sample1 / sample2 only) ──────────────────────── #}
{% if club and club.short_name in ('sample1', 'sample2') %}
<div id="demoBanner" class="demo-banner">
  <div class="demo-banner-inner">
    <span class="demo-badge"><i class="bi bi-eye me-1"></i>Demo Site</span>
    <span class="demo-text">
      You are exploring <strong>{{ club.name }}</strong> — a live FleetNests demo.
      {% if current_user %}You are logged in as a club administrator.{% endif %}
    </span>
    <span class="demo-reset">
      <i class="bi bi-arrow-clockwise me-1"></i>Data resets nightly.
    </span>
  </div>
</div>
{% endif %}

{% if current_user %}
<nav class="navbar navbar-expand-md navbar-dark bg-club-blue">
  <div class="container-fluid">
    <a class="navbar-brand" href="{{ url_for('calendar') }}">
      <img src="{{ url_for('club_logo') }}"
           class="brand-badge" alt="{{ club.name if club else 'FleetNests' }}"
           width="34" height="34" style="height:34px;width:auto;max-width:120px;flex-shrink:0">
      {{ club.name if club else 'FleetNests' }}
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMain">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navMain">
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <a class="nav-link {% if request.endpoint == 'calendar' %}active{% endif %}"
             href="{{ url_for('calendar') }}"><i class="bi bi-calendar3 me-1"></i>Calendar</a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if request.endpoint == 'my_reservations' %}active{% endif %}"
             href="{{ url_for('my_reservations') }}">
            <i class="bi bi-bookmark-star me-1"></i>
            {% if is_plane %}My Flights{% else %}My Trips{% endif %}
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if request.endpoint == 'stats' %}active{% endif %}"
             href="{{ url_for('stats') }}"><i class="bi bi-bar-chart me-1"></i>Stats</a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if request.endpoint in ('messages','new_message') %}active{% endif %}"
             href="{{ url_for('messages') }}"><i class="bi bi-chat-square-text me-1"></i>Messages</a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if request.endpoint == 'rules_page' %}active{% endif %}"
             href="{{ url_for('rules_page') }}"><i class="bi bi-journal-bookmark me-1"></i>Rules</a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if request.endpoint == 'statements' %}active{% endif %}"
             href="{{ url_for('statements') }}"><i class="bi bi-file-earmark-pdf me-1"></i>Statements</a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if request.endpoint == 'gallery' %}active{% endif %}"
             href="{{ url_for('gallery') }}"><i class="bi bi-images me-1"></i>Gallery</a>
        </li>
        <li class="nav-item">
          <a class="nav-link {% if request.endpoint == 'help_page' %}active{% endif %}"
             href="{{ url_for('help_page') }}"><i class="bi bi-question-circle me-1"></i>Help</a>
        </li>
        {% if current_user.can_manage_statements and not current_user.is_admin %}
        <li class="nav-item">
          <a class="nav-link {% if request.endpoint == 'admin_statements' %}active{% endif %}"
             href="{{ url_for('admin_statements') }}">
            <i class="bi bi-file-earmark-arrow-up me-1"></i>Upload Statement
          </a>
        </li>
        {% endif %}
        {% if current_user.is_admin %}
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle {% if request.endpoint and 'admin' in request.endpoint %}active{% endif %}"
             href="#" data-bs-toggle="dropdown">
            <i class="bi bi-shield-check me-1"></i>Admin
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="{{ url_for('admin_users') }}"><i class="bi bi-people me-1"></i>Members</a></li>
            <li><a class="dropdown-item" href="{{ url_for('admin_settings') }}"><i class="bi bi-gear me-1"></i>Settings</a></li>
            <li><a class="dropdown-item" href="{{ url_for('admin_blackouts') }}"><i class="bi bi-calendar-x me-1"></i>Blackout Dates</a></li>
            <li><a class="dropdown-item" href="{{ url_for('admin_approvals') }}"><i class="bi bi-hourglass-split me-1"></i>Approvals</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{{ url_for('admin_incidents') }}"><i class="bi bi-exclamation-triangle me-1"></i>Incidents</a></li>
            <li><a class="dropdown-item" href="{{ url_for('admin_fuel') }}"><i class="bi bi-fuel-pump me-1"></i>Fuel Log</a></li>
            <li><a class="dropdown-item" href="{{ url_for('admin_trip_logs') }}"><i class="bi bi-journal-bookmark me-1"></i>Trip Logs</a></li>
            <li><a class="dropdown-item" href="{{ url_for('admin_feedback') }}"><i class="bi bi-chat-left-text me-1"></i>Feedback</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{{ url_for('admin_audit_log') }}"><i class="bi bi-journal-text me-1"></i>Audit Log</a></li>
            <li><a class="dropdown-item" href="{{ url_for('admin_export_csv') }}"><i class="bi bi-download me-1"></i>Export CSV</a></li>
            {% if current_user.can_manage_statements %}
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{{ url_for('admin_statements') }}"><i class="bi bi-file-earmark-arrow-up me-1"></i>Upload Statement</a></li>
            {% endif %}
          </ul>
        </li>
        {% endif %}
      </ul>
      <ul class="navbar-nav">
        {% if current_sadmin %}
        <li class="nav-item">
          <a class="nav-link text-warning" href="{{ url_for('superadmin_dashboard') }}"
             title="Super Admin Panel">
            <i class="bi bi-shield-shaded me-1"></i><span class="badge bg-warning text-dark">SA</span>
          </a>
        </li>
        {% endif %}
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
            <i class="bi bi-person-circle me-1"></i>{{ current_user.full_name }}
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="{{ url_for('profile') }}">
              <i class="bi bi-person-gear me-1"></i>Profile</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="{{ url_for('logout') }}">
              <i class="bi bi-box-arrow-right me-1"></i>Log Out</a></li>
          </ul>
        </li>
      </ul>
    </div>
  </div>
</nav>
{% endif %}

<main class="container-fluid py-3 px-3">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  {% block content %}{% endblock %}
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Initialize Bootstrap tooltips globally for all help icons
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function (el) {
      new bootstrap.Tooltip(el, { trigger: 'hover focus' });
    });
  });
</script>
{% block scripts %}{% endblock %}

{% if current_user %}
{# ── Floating feedback button ─────────────────────────────────────────── #}
<button class="btn btn-gold rounded-pill shadow"
        style="position:fixed;bottom:1.5rem;right:1.5rem;z-index:1050;"
        data-bs-toggle="modal" data-bs-target="#feedbackModal">
  <i class="bi bi-chat-heart me-1"></i>Feedback
</button>

{# ── Feedback modal ───────────────────────────────────────────────────── #}
<div class="modal fade" id="feedbackModal" tabindex="-1"
     aria-labelledby="feedbackModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">

      <div class="modal-header text-white"
           style="background:linear-gradient(135deg,#0A2342 0%,#1a3a5c 100%);">
        <h5 class="modal-title" id="feedbackModalLabel"
            style="font-family:'Playfair Display',serif;color:#C9A84C;">
          <i class="bi bi-chat-heart me-2"></i>Share Feedback
        </h5>
        <button type="button" class="btn-close btn-close-white"
                data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        {# Default state: form #}
        <div id="fbForm">
          <p class="text-muted small mb-3">
            <i class="bi bi-bug me-1"></i>Bugs &amp; feature requests → GitHub &nbsp;·&nbsp;
            <i class="bi bi-envelope me-1"></i>Everything else → email
          </p>
          <div class="mb-3">
            <label for="fbText" class="form-label fw-semibold">Your feedback</label>
            <textarea id="fbText" class="form-control" rows="5"
                      maxlength="4000" required
                      placeholder="Describe a bug, suggest a feature, or share a thought…"></textarea>
            <div class="form-text text-end">
              <span id="fbCharCount">0</span> / 4000
            </div>
          </div>
          <div class="mb-2">
            <label for="fbScreenshot" class="form-label fw-semibold">
              Screenshot <span class="text-muted fw-normal">(optional)</span>
            </label>
            <input type="file" id="fbScreenshot" class="form-control"
                   accept="image/jpeg,image/png,image/gif,image/webp,application/pdf,.pdf">
            <div class="form-text">JPEG, PNG, GIF, WebP, or PDF · max 5 MB</div>
          </div>
          <div id="fbErrorBanner" class="alert alert-danger py-2 d-none" role="alert"></div>
        </div>

        {# Success state: hidden initially #}
        <div id="fbSuccess" class="text-center py-4 d-none">
          <i class="bi bi-check-circle-fill text-success" style="font-size:2.5rem;"></i>
          <p class="mt-3 mb-0 fw-semibold" id="fbSuccessMsg"></p>
        </div>
      </div>

      <div class="modal-footer" id="fbFooter">
        <button type="button" class="btn btn-outline-secondary"
                data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-gold" id="fbSendBtn"
                onclick="submitFeedback()">
          <span id="fbBtnLabel"><i class="bi bi-send me-1"></i>Send</span>
          <span id="fbBtnSpinner" class="d-none">
            <span class="spinner-border spinner-border-sm me-1" role="status"></span>Sending…
          </span>
        </button>
      </div>

    </div>
  </div>
</div>

<script>
(function () {
  // Reset modal to default state on every open
  document.getElementById('feedbackModal').addEventListener('show.bs.modal', function () {
    document.getElementById('fbText').value = '';
    document.getElementById('fbScreenshot').value = '';
    document.getElementById('fbCharCount').textContent = '0';
    document.getElementById('fbErrorBanner').classList.add('d-none');
    document.getElementById('fbErrorBanner').textContent = '';
    document.getElementById('fbForm').classList.remove('d-none');
    document.getElementById('fbSuccess').classList.add('d-none');
    document.getElementById('fbFooter').classList.remove('d-none');
    _fbSetSending(false);
  });

  document.getElementById('fbText').addEventListener('input', function () {
    document.getElementById('fbCharCount').textContent = this.value.length;
  });

  function _fbSetSending(sending) {
    document.getElementById('fbSendBtn').disabled = sending;
    document.getElementById('fbBtnLabel').classList.toggle('d-none', sending);
    document.getElementById('fbBtnSpinner').classList.toggle('d-none', !sending);
  }

  window.submitFeedback = function () {
    var text = document.getElementById('fbText').value.trim();
    if (!text) {
      var banner = document.getElementById('fbErrorBanner');
      banner.textContent = 'Please enter your feedback before sending.';
      banner.classList.remove('d-none');
      return;
    }

    _fbSetSending(true);
    document.getElementById('fbErrorBanner').classList.add('d-none');

    var fd = new FormData();
    fd.append('feedback_text', text);
    var file = document.getElementById('fbScreenshot').files[0];
    if (file) fd.append('screenshot', file);

    fetch('{{ url_for("submit_feedback") }}', {method: 'POST', body: fd})
      .then(function (r) { return r.json().then(function (d) { return {ok: r.ok, data: d}; }); })
      .then(function (res) {
        if (res.data.ok) {
          var msgs = {
            'github_issue':   'Filed as a GitHub issue — thanks for the report!',
            'email':          'Sent to the club team — thanks for the feedback!',
            'fallback_email': 'Sent to the club team — thanks!'
          };
          document.getElementById('fbForm').classList.add('d-none');
          document.getElementById('fbFooter').classList.add('d-none');
          document.getElementById('fbSuccessMsg').textContent =
            msgs[res.data.action] || 'Feedback sent — thank you!';
          document.getElementById('fbSuccess').classList.remove('d-none');
          setTimeout(function () {
            bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
          }, 3000);
        } else {
          var banner = document.getElementById('fbErrorBanner');
          banner.textContent = res.data.error || 'Something went wrong. Please try again.';
          banner.classList.remove('d-none');
          _fbSetSending(false);
        }
      })
      .catch(function () {
        var banner = document.getElementById('fbErrorBanner');
        banner.textContent = 'Network error. Please check your connection and try again.';
        banner.classList.remove('d-none');
        _fbSetSending(false);
      });
  };
}());
</script>
{% endif %}
</body>
</html>
