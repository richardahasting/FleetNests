{% extends "base.html" %}
{% block title %}{{ day.strftime('%B %d, %Y') }} â€” {{ club.name if club else 'FleetNests' }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-md-7 col-lg-6">

    <div class="d-flex align-items-center mb-3">
      <a href="{{ url_for('calendar') }}" class="btn btn-sm btn-outline-secondary me-3">
        <i class="bi bi-arrow-left"></i>
      </a>
      <h5 class="mb-0 fw-bold">{{ day.strftime('%A, %B %d, %Y') }}</h5>
    </div>

    {% if vehicle_photo %}
    <div class="vehicle-photo-card mb-3 shadow-sm">
      <img src="{{ url_for('vehicle_photo', photo_id=vehicle_photo.id) }}"
           alt="{{ vehicle_photo.caption or ('The ' + (club.name if club else 'Club') + ' vessel') }}"
           class="w-100" style="max-height:240px;object-fit:cover;">
      {% if vehicle_photo.caption %}
      <div class="px-3 py-2 small text-muted bg-white">{{ vehicle_photo.caption }}</div>
      {% endif %}
    </div>
    {% endif %}

    {# ---- Existing reservations for this day ---- #}
    {% if existing %}
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-header bg-light fw-semibold small text-muted">
        <i class="bi bi-clock me-1"></i>Already reserved today
      </div>
      <ul class="list-group list-group-flush">
        {% for res in existing %}
        <li class="list-group-item py-2">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div>
                <div class="res-avatar-sm d-inline-flex me-2">{{ res.full_name[0] }}</div>
                <strong>{{ res.full_name }}</strong>
                {% if res.vehicle_name %}
                <span class="badge bg-secondary ms-1" style="font-size:0.7rem">{{ res.vehicle_name }}</span>
                {% endif %}
                <span class="text-muted ms-2">
                  {{ res.start_time.strftime('%-I:%M %p') }} â€“ {{ res.end_time.strftime('%-I:%M %p') }} CT
                </span>
              </div>
              {% if res.notes %}
              <div class="text-secondary small ms-4 mt-1">
                <i class="bi bi-chat-left-text me-1"></i>{{ res.notes }}
              </div>
              {% endif %}
            </div>
            {% if res.user_id == current_user.id or current_user.is_admin %}
            <form method="post" action="{{ url_for('cancel_reservation', res_id=res.id) }}" class="ms-2">
              <button type="submit" class="btn btn-sm btn-outline-danger"
                      onclick="return confirm('Cancel this reservation?')">
                <i class="bi bi-x-circle"></i>
              </button>
            </form>
            {% endif %}
          </div>
        </li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}

{# ---- Waitlist / partial-booking notice ---- #}
{% if day >= today and existing and not user_has_res %}
<div class="card border-0 shadow-sm mb-3">
  <div class="card-body py-3 px-4">
    {% if day_is_fully_booked %}
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <div class="fw-semibold small">
          This day is fully booked.
          <a href="{{ url_for('help_page') }}#waitlist" class="text-muted ms-1"
             data-bs-toggle="tooltip" title="Help: How the waitlist works">
            <i class="bi bi-question-circle-fill" style="font-size:0.8rem"></i>
          </a>
        </div>
        <div class="text-muted small">Join the waitlist to be notified if a slot opens.</div>
      </div>
      {% if on_waitlist %}
      <form method="post" action="{{ url_for('waitlist_leave', res_date=day.isoformat()) }}">
        <button type="submit" class="btn btn-sm btn-outline-secondary">
          <i class="bi bi-x me-1"></i>Leave Waitlist
        </button>
      </form>
      {% else %}
      <form method="post" action="{{ url_for('waitlist_join', res_date=day.isoformat()) }}" class="d-flex gap-2">
        <button type="submit" class="btn btn-sm btn-outline-club-blue">
          <i class="bi bi-hourglass-split me-1"></i>Join Waitlist
        </button>
      </form>
      {% endif %}
    </div>
    {% else %}
    <div class="text-muted small">
      <i class="bi bi-clock me-1"></i>Some time slots on this day are taken â€” additional slots are still available below.
    </div>
    {% endif %}
  </div>
</div>
{% endif %}

{# ---- Weather forecast ---- #}
{% set days_ahead = (day - today).days %}
{% if 0 <= days_ahead <= 6 %}
<div class="card border-0 shadow-sm mb-3" id="weatherCard">
  <div class="card-body py-2 px-3">
    <small class="text-muted"><i class="bi bi-cloud-sun me-1"></i>Forecast</small>
    <div id="weatherData" class="mt-1 text-muted small">Loading...</div>
  </div>
</div>
{% endif %}

    {# ---- Reserve form ---- #}
    {% if day < today %}
    <div class="card border-0 shadow-sm">
      <div class="card-body">
        <div class="alert alert-secondary mb-0">
          <i class="bi bi-calendar-x me-1"></i>This date is in the past.
        </div>
      </div>
    </div>

    {% else %}
    <div class="card border-0 shadow-sm">
      <div class="card-body p-4">
        <h6 class="fw-semibold mb-3">
          <i class="bi bi-plus-circle me-1 text-club-blue"></i>Make a Reservation
          <a href="{{ url_for('help_page') }}#making-reservation" class="text-muted ms-1"
             data-bs-toggle="tooltip" title="Help: Reservation rules and how booking works">
            <i class="bi bi-question-circle-fill" style="font-size:0.8rem"></i>
          </a>
        </h6>
        <p class="text-muted small mb-3">
          Minimum <strong>2 hours</strong>, maximum <strong>6 hours</strong>.
          Max 3 consecutive days Â· Max 3 upcoming reservations total.
        </p>

        <form method="post" id="reserveForm">

          {# ---- Vehicle selection ---- #}
          {% if vehicles|length == 1 %}
          {# Single vehicle â€” auto-select silently #}
          <input type="hidden" name="vehicle_id" value="{{ vehicles[0].id }}">
          <p class="text-muted small mb-3">
            <i class="bi bi-{% if is_plane %}airplane{% else %}tsunami{% endif %} me-1"></i>
            <strong>{{ vehicles[0].name }}</strong>
            {% if vehicles[0].tail_number %} Â· {{ vehicles[0].tail_number }}{% elif vehicles[0].registration_number %} Â· {{ vehicles[0].registration_number }}{% endif %}
          </p>
          {% else %}
          <div class="mb-3">
            <label class="form-label fw-semibold">
              Select {% if is_plane %}Aircraft{% else %}Vessel{% endif %}
              <span class="text-muted fw-normal">(choose one or more)</span>
            </label>
            <div class="vehicle-select-grid" id="vehicleCheckboxes">
              {% for v in vehicles %}
              {% set booked_now = existing | selectattr("vehicle_id", "equalto", v.id) | list %}
              <label class="vehicle-select-card {% if booked_now %}vehicle-select-card--busy{% endif %}"
                     for="v{{ v.id }}">
                <input class="vehicle-checkbox" type="checkbox" name="vehicle_id"
                       id="v{{ v.id }}" value="{{ v.id }}"
                       {% if booked_now %}data-busy="1"{% endif %}>
                <span class="vehicle-select-info">
                  <span class="vehicle-select-name">{{ v.name }}</span>
                  {% if v.tail_number %}
                  <span class="vehicle-select-reg">{{ v.tail_number }}</span>
                  {% elif v.registration_number %}
                  <span class="vehicle-select-reg">{{ v.registration_number }}</span>
                  {% endif %}
                  {% if booked_now %}
                  <span class="vehicle-select-busy-badge">
                    <i class="bi bi-clock me-1"></i>Has reservations today
                  </span>
                  {% else %}
                  <span class="vehicle-select-avail-badge">
                    <i class="bi bi-check-circle me-1"></i>Available
                  </span>
                  {% endif %}
                </span>
              </label>
              {% endfor %}
            </div>
          </div>
          {% endif %}

          <div class="row g-3">
            <div class="col-6">
              <label class="form-label" for="start_time">Start Time</label>
              <select class="form-select" id="start_time" name="start_time" required>
                <option value="">â€” select â€”</option>
                {% for h in range(0, 24) %}
                  {% for m in [0, 30] %}
                    {% set hh = '%02d'|format(h) %}
                    {% set mm = '%02d'|format(m) %}
                    {% set ampm = 'AM' if h < 12 else 'PM' %}
                    {% set h12 = h if h <= 12 else h - 12 %}
                    {% set h12 = 12 if h12 == 0 else h12 %}
                <option value="{{ hh }}:{{ mm }}">{{ h12 }}:{{ mm }} {{ ampm }}</option>
                  {% endfor %}
                {% endfor %}
              </select>
            </div>
            <div class="col-6">
              <label class="form-label" for="end_time">End Time</label>
              <select class="form-select" id="end_time" name="end_time" required disabled>
                <option value="">â€” pick start first â€”</option>
              </select>
            </div>
          </div>

          {# Live duration feedback #}
          <div id="durationHint" class="form-text mt-2"></div>

          <div class="mt-3">
            <label class="form-label" for="notes">
              Notes <span class="text-muted fw-normal">(optional)</span>
            </label>
            <textarea class="form-control" id="notes" name="notes"
                      rows="2" maxlength="300"
                      placeholder="e.g. fishing trip, water skiing, family outingâ€¦"></textarea>
            <div class="form-text text-end">
              <span id="notesCount">0</span>/300
            </div>
          </div>

          <button type="submit" class="btn btn-club-blue mt-3 w-100" id="submitBtn" disabled>
            <i class="bi bi-check-lg me-1"></i><span id="submitLabel">Reserve</span>
          </button>
        </form>
      </div>
    </div>
    {% endif %}

  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function () {
  const startEl    = document.getElementById('start_time');
  const endEl      = document.getElementById('end_time');
  const hint       = document.getElementById('durationHint');
  const btn        = document.getElementById('submitBtn');
  const submitLbl  = document.getElementById('submitLabel');
  const notesEl    = document.getElementById('notes');
  const countEl    = document.getElementById('notesCount');
  const checkboxes = Array.from(document.querySelectorAll('.vehicle-checkbox'));
  // If there's a hidden single-vehicle input instead of checkboxes, treat as always-selected
  const singleMode = checkboxes.length === 0;

  if (notesEl && countEl) {
    notesEl.addEventListener('input', () => { countEl.textContent = notesEl.value.length; });
  }

  if (!startEl) return;

  function fmt12(totalMins) {
    const h24 = Math.floor(totalMins / 60) % 24;
    const m    = totalMins % 60;
    const ampm = h24 < 12 ? 'AM' : 'PM';
    const h12  = h24 % 12 || 12;
    return {
      label: h12 + ':' + String(m).padStart(2, '0') + ' ' + ampm,
      value: String(h24).padStart(2, '0') + ':' + String(m).padStart(2, '0')
    };
  }

  function makeOpt(value, label) {
    const o = document.createElement('option');
    o.value = value;
    o.textContent = label;
    return o;
  }

  function selectedVehicles() {
    return singleMode ? ['1'] : checkboxes.filter(c => c.checked);
  }

  function updateSubmit() {
    const hasVehicle = singleMode || checkboxes.some(c => c.checked);
    const hasTime    = startEl.value && endEl.value;
    btn.disabled = !(hasVehicle && hasTime);

    if (!hasTime) return;
    const [sh, sm] = startEl.value.split(':').map(Number);
    const [eh, em] = endEl.value.split(':').map(Number);
    const hrs = ((eh * 60 + em) - (sh * 60 + sm)) / 60;
    hint.className = 'form-text text-success';
    hint.textContent = (hrs % 1 === 0 ? hrs : hrs.toFixed(1)) + ' hours';

    if (!singleMode) {
      const checked = checkboxes.filter(c => c.checked);
      if (checked.length > 1) {
        const names = checked.map(c => c.closest('label').querySelector('.vehicle-select-name').textContent.trim());
        submitLbl.textContent = `Reserve ${names.join(' & ')}`;
      } else if (checked.length === 1) {
        const name = checked[0].closest('label').querySelector('.vehicle-select-name').textContent.trim();
        submitLbl.textContent = `Reserve ${name}`;
      } else {
        submitLbl.textContent = 'Reserve';
      }
    }
  }

  function populateEndTimes() {
    while (endEl.firstChild) endEl.removeChild(endEl.firstChild);
    endEl.disabled = true;
    hint.textContent = '';

    if (!startEl.value) {
      endEl.appendChild(makeOpt('', 'â€” pick start first â€”'));
      updateSubmit();
      return;
    }

    const [sh, sm] = startEl.value.split(':').map(Number);
    const startMins = sh * 60 + sm;
    endEl.appendChild(makeOpt('', 'â€” select â€”'));
    for (let t = startMins + 120; t <= startMins + 360 && t <= 1440; t += 30) {
      const f = fmt12(t);
      endEl.appendChild(makeOpt(f.value, f.label));
    }
    endEl.disabled = false;
    updateSubmit();
  }

  // Highlight selected vehicle cards
  checkboxes.forEach(cb => {
    cb.addEventListener('change', function () {
      this.closest('label').classList.toggle('vehicle-select-card--selected', this.checked);
      updateSubmit();
    });
  });

  // If single-mode, enable button as soon as times are set
  if (singleMode) btn.disabled = true;

  startEl.addEventListener('change', populateEndTimes);
  endEl.addEventListener('change', updateSubmit);
})();
</script>

<script>
// Weather from Open-Meteo (free, no key required)
// Boat location: Lake Belton, TX approximate coordinates
const weatherCard = document.getElementById('weatherData');
if (weatherCard) {
  const lat = 31.15, lon = -97.47;  // Lake Belton, TX
  const dateStr = '{{ day.isoformat() }}';
  fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,windspeed_10m_max,weathercode&temperature_unit=fahrenheit&windspeed_unit=mph&timezone=America%2FChicago&start_date=${dateStr}&end_date=${dateStr}`)
    .then(r => r.json())
    .then(data => {
      const d = data.daily;
      const wmo = d.weathercode[0];
      const desc = wmoDescription(wmo);
      const icon = wmoIcon(wmo);
      weatherCard.innerHTML = `${icon} <strong>${desc}</strong> &nbsp;
        <span class="text-dark">High ${Math.round(d.temperature_2m_max[0])}Â°F / Low ${Math.round(d.temperature_2m_min[0])}Â°F</span> &nbsp;
        <i class="bi bi-droplet text-primary"></i> ${d.precipitation_probability_max[0]}% rain &nbsp;
        <i class="bi bi-wind"></i> ${Math.round(d.windspeed_10m_max[0])} mph`;
    })
    .catch(() => { weatherCard.textContent = 'Forecast unavailable.'; });
}

function wmoDescription(code) {
  if (code === 0) return 'Clear sky';
  if (code <= 2) return 'Partly cloudy';
  if (code === 3) return 'Overcast';
  if (code <= 49) return 'Foggy';
  if (code <= 59) return 'Drizzle';
  if (code <= 69) return 'Rain';
  if (code <= 79) return 'Snow';
  if (code <= 82) return 'Rain showers';
  if (code <= 99) return 'Thunderstorms';
  return 'Unknown';
}
function wmoIcon(code) {
  if (code === 0) return 'â˜€ï¸';
  if (code <= 2) return 'â›…';
  if (code === 3) return 'â˜ï¸';
  if (code <= 49) return 'ðŸŒ«ï¸';
  if (code <= 69) return 'ðŸŒ§ï¸';
  if (code <= 79) return 'â„ï¸';
  if (code <= 82) return 'ðŸŒ¦ï¸';
  return 'â›ˆï¸';
}
</script>
{% endblock %}